<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>脉图：让关系，一目了然</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }
    .page {
      width: 100vw;
      height: 100vh;
      display: flex;
      overflow: hidden;
    }
    /* 左侧边栏 */
    .sidebar {
      width: 250px;
      background: #fff;
      box-shadow: 2px 0 8px rgba(0,0,0,0.1);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 10px 0;
    }
    .logo img {
      height: 80px;
      width: auto;
    }
    .logo-text-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .logo-text-cn {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      line-height: 1.2;
    }
    .logo-text-en {
      font-size: 14px;
      font-weight: 500;
      color: #666;
      line-height: 1.2;
    }
    .create-btn {
      width: 90%;
      padding: 8px;
      text-align: center;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.1s ease;
      margin: 0 auto;
    }
    .create-btn:hover {
      transform: translateY(-1px);
    }
    /* 右侧内容区 */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    /* 右侧顶部栏 */
    .header {
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 32px;
      flex: 1;
    }
    .logo-text {
      font-size: 18px;
      font-weight: 800;
      color: #333;
    }
    .search-box {
      flex: 1;
      max-width: 400px;
      position: relative;
    }
    .search-input {
      width: 100%;
      padding: 10px 40px 10px 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }
    .search-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102,126,234,0.18);
    }
    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #999;
      cursor: pointer;
      font-size: 16px;
      transition: color 0.2s ease;
      width: 20px;
      height: 20px;
    }
    .search-icon svg {
      width: 100%;
      height: 100%;
    }
    .search-icon:hover {
      color: #667eea;
    }
    .header-right {
      display: flex;
      align-items: center;
    }
    /* 用户菜单 */
    .user-menu {
      position: relative;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 8px;
      transition: background-color 0.2s ease;
    }
    .user-info:hover {
      background-color: #f5f5f5;
    }
    .user-name {
      font-weight: 600;
      color: #333;
    }
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #eee;
      object-fit: cover;
    }
    /* 用户下拉菜单 */
    .user-dropdown {
      position: fixed;
      min-width: 180px;
      z-index: 999999;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      padding: 12px 0;
      border: 1px solid #e5e7eb;
      opacity: 1;
      visibility: visible;
      transition: all 0.2s ease;
      min-height: 100px;
    }
    
    .user-dropdown.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transform: translateY(-10px);
    }
    
    /* 确保下拉菜单项可见 */
    .user-dropdown .dropdown-item {
      padding: 12px 16px;
      font-size: 14px;
      color: #333;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    
    .user-dropdown .dropdown-item:hover {
      background-color: #f5f5f5;
    }
    
    .user-dropdown .dropdown-divider {
      height: 1px;
      background-color: #e5e7eb;
      margin: 8px 0;
    }
    /* 右侧内容区 */
    .content {
      flex: 1;
      padding: 24px;
      overflow: auto;
      background-color: #f5f5f5;
    }
    .content-header {
      margin-bottom: 20px;
    }
    .content-title {
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin: 0;
    }
    /* 关系图网格 */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
    }
    /* 关系图卡片 */
    .card {
      border: 1px solid #eee;
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
      cursor: pointer;
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      border-color: rgba(102,126,234,0.6);
      box-shadow: 0 10px 22px rgba(0,0,0,0.10);
    }
    .card.dragging {
      opacity: 0.5;
      transform: rotate(2deg);
      cursor: grabbing;
    }
    .card.drag-over {
      border-color: #667eea;
      border-width: 2px;
      background-color: rgba(102,126,234,0.05);
    }
    .drag-indicator {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(180deg, #667eea, #764ba2);
      border-radius: 2px;
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 10001;
    }
    .drag-indicator.show {
      opacity: 1;
    }
    .drag-indicator-left {
      left: -2px;
    }
    .drag-indicator-right {
      right: -2px;
    }
    .drag-handle {
      position: absolute;
      top: 8px;
      left: 8px;
      cursor: grab;
      opacity: 0;
      transition: opacity 0.2s ease;
      color: #999;
      background: rgba(255,255,255,0.9);
      border-radius: 4px;
      padding: 2px;
    }
    .card:hover .drag-handle {
      opacity: 1;
    }
    .drag-handle:active {
      cursor: grabbing;
    }
    .thumb {
      height: 180px;
      background: linear-gradient(135deg, rgba(102,126,234,0.10), rgba(118,75,162,0.06));
      display: grid;
      place-items: center;
      color: #667eea;
      font-weight: 900;
      font-size: 34px;
      letter-spacing: 1px;
    }
    .card-body { padding: 12px 12px; }
    .name { font-weight: 800; color: #333; margin-bottom: 6px; }
    .meta { font-size: 12px; color: #888; }
    .empty {
      color: #666;
      text-align: center;
      padding: 60px 0;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    /* 卡片更多按钮样式 */
    .card { position: relative; }
    .card-more {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(255,255,255,0.9);
      border: none;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: background .15s;
      z-index: 10;
    }
    .card:hover .card-more { display: flex; }
    .card-more:hover { background: #fff; }
    .card-more svg { width: 16px; height: 16px; color: #555; }
    /* 下拉菜单样式 */
    .dropdown-menu {
      position: fixed;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.18);
      min-width: 160px;
      padding: 6px 0 12px 0;
      display: none;
      z-index: 1000;
    }
    .dropdown-menu.show { display: block; }
    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      cursor: pointer;
      font-size: 14px;
      color: #333;
      transition: background .1s;
    }
    .dropdown-item:hover { background: #f5f5f5; }
    .dropdown-item svg { width: 16px; height: 16px; color: #666; }
    .dropdown-item.danger { color: #e53935; }
    .dropdown-item.danger svg { color: #e53935; }
    .dropdown-item.admin-only { display: none; }
    body.admin-user .dropdown-item.admin-only { display: flex; }
    /* 导出选择样式 */
    .dropdown-with-select {
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px 14px;
    }
    .dropdown-select-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }
    .export-format-select {
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      background: #fff;
      cursor: pointer;
    }
    .export-format-select:focus {
      outline: none;
      border-color: #667eea;
    }
    .export-btn {
      padding: 4px 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 13px;
      cursor: pointer;
    }
    .export-btn:hover {
      opacity: 0.9;
    }
    .dropdown-divider {
      height: 1px;
      background: #eee;
      margin: 6px 0;
    }

    /* SweetAlert2 自定义样式 */
    .swal2-title-sm {
      font-size: 16px !important;
      font-weight: 700 !important;
    }
    .swal2-content-sm {
      font-size: 14px !important;
    }
    .swal2-btn-sm {
      font-size: 13px !important;
      padding: 8px 16px !important;
    }

    /* 响应式调整 */
    @media (max-width: 768px) {
      .sidebar {
        width: 240px;
      }
      .grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
      }
      .content {
        padding: 16px;
      }
    }
    
    /* 模态框样式 */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal.hidden {
      display: none;
    }
    .modal-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      cursor: pointer;
    }
    .modal-content {
      position: relative;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 480px;
      max-height: 90vh;
      overflow-y: auto;
      z-index: 1001;
    }
    .modal-content-large {
      max-width: 800px;
    }
    .user-management-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e5e7eb;
    }
    .user-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .user-list-container {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
    }
    .user-list-header {
      display: flex;
      align-items: center;
      background: #f9fafb;
      padding: 14px 20px;
      font-weight: 600;
      font-size: 13px;
      color: #666;
    }
    .user-list-header-cell {
      display: flex;
      align-items: center;
    }
    .user-list-header-avatar {
      width: 40px;
    }
    .user-list-header-info {
      flex: 1.5;
    }
    .user-list-header-username {
      flex: 1.2;
    }
    .user-list-header-time {
      flex: 1.5;
    }
    .user-list-header-status {
      flex: 0.8;
    }
    .user-list-header-actions {
      flex: 2.5;
    }
    .user-item {
      display: flex;
      align-items: center;
      padding: 14px 20px;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s ease;
    }
    .user-item:hover {
      background: #f9fafb;
    }
    .user-item-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 600;
      font-size: 14px;
    }
    .user-item-info {
      flex: 1.5;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .user-item-details {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .user-item-name {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    .user-item-username {
      flex: 1.2;
      font-size: 13px;
      color: #666;
    }
    .user-item-time {
      flex: 1.5;
      font-size: 13px;
      color: #666;
    }
    .user-item-status {
      flex: 0.8;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 500;
      text-align: center;
    }
    .user-item-status.active {
      background: #d1fae5;
      color: #065f46;
    }
    .user-item-status.disabled {
      background: #fee2e2;
      color: #991b1b;
    }
    .user-item-actions {
      flex: 2.5;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .user-item-btn {
      padding: 4px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: #fff;
      color: #666;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .user-item-btn:hover {
      background: #f5f5f5;
    }
    .user-item-btn.danger {
      color: #e53935;
      border-color: #fecaca;
    }
    .user-item-btn.danger:hover {
      background: #fef2f2;
    }
    .modal-header {
      padding: 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-header h3 {
      font-size: 18px;
      font-weight: 700;
      color: #333;
      margin: 0;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #999;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.3s ease;
    }
    .modal-close:hover {
      background: #f3f4f6;
      color: #333;
    }
    .modal-body {
      padding: 24px;
    }
    .modal-footer {
      padding: 24px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    .form-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }
    .btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(102,126,234,0.4);
    }
    .btn-secondary {
      background: #f3f4f6;
      color: #666;
    }
    .btn-secondary:hover {
      background: #e5e7eb;
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- 左侧边栏 -->
    <div class="sidebar">
      <div class="logo">
        <img src="images/logo.png" alt="Logo">
        <div class="logo-text-container">
          <div class="logo-text-cn">脉图</div>
          <div class="logo-text-en">MindMaple</div>
        </div>
      </div>
      <button id="btnCreate" class="create-btn">+&nbsp;&nbsp;&nbsp;新建关系图</button>
    </div>

    <!-- 右侧内容区 -->
    <div class="main-content">
      <!-- 右侧顶部栏 -->
      <div class="header">
        <div class="header-left">
          <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="搜索关系图..." />
            <div class="search-icon" id="searchIcon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </div>
          </div>
        </div>
        <div class="header-right">
          <!-- 用户信息 -->
          <div class="user-menu">
            <div class="user-info" id="userInfo">
              <span id="nickname" class="user-name">未登录</span>
              <img id="avatar" class="avatar" alt="" />
            </div>
          </div>
        </div>
      </div>

      <!-- 右侧内容区 -->
      <div class="content">
        <div class="content-header">
          <h2 class="content-title">我的关系图</h2>
        </div>
        <div id="grid" class="grid"></div>
        <div id="empty" class="empty" style="display:none;">还没有关系图，先创建一个吧。</div>
      </div>
    </div>
  </div>

  <!-- 隐藏的画布用于导出 -->
  <canvas id="exportCanvas" style="display:none;"></canvas>

  <!-- 全局下拉菜单容器 -->
  <div id="dropdownMenuContainer"></div>

  <!-- 用户下拉菜单 -->
  <div class="dropdown-menu user-dropdown hidden" id="userDropdown">
    <div class="dropdown-item" onclick="navigateToProfile()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
        <circle cx="12" cy="7" r="4"/>
      </svg>
      个人中心
    </div>
    <div class="dropdown-item admin-only" onclick="openUserManagementModal()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <path d="M23 21v-2a4 4 0 0 0-4-4h-3"/>
        <circle cx="17" cy="7" r="4"/>
      </svg>
      用户管理
    </div>
    <div class="dropdown-item" onclick="openChangePasswordModal()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
      </svg>
      修改密码
    </div>
    <div class="dropdown-divider"></div>
    <div class="dropdown-item" onclick="handleLogout()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
        <polyline points="16 17 21 12 16 7"/>
        <line x1="21" y1="12" x2="9" y2="12"/>
      </svg>
      退出登录
    </div>
  </div>

  <!-- SweetAlert2 -->
  <script src="sweetalert2@11.js"></script>

  <!-- 修改密码模态框 -->
  <div class="modal hidden" id="changePasswordModal">
    <div class="modal-overlay" onclick="closeChangePasswordModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3>修改密码</h3>
        <button class="modal-close" onclick="closeChangePasswordModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" for="currentPassword">当前密码</label>
          <input type="password" id="currentPassword" class="form-input" placeholder="请输入当前密码">
        </div>
        <div class="form-group">
          <label class="form-label" for="newPassword">新密码</label>
          <input type="password" id="newPassword" class="form-input" placeholder="请输入新密码">
        </div>
        <div class="form-group">
          <label class="form-label" for="changeConfirmPassword">确认新密码</label>
          <input type="password" id="changeConfirmPassword" class="form-input" placeholder="请再次输入新密码">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeChangePasswordModal()">取消</button>
        <button class="btn btn-primary" onclick="handleChangePassword()">确认修改</button>
      </div>
    </div>
  </div>

  <!-- 用户管理模态框 -->
  <div class="modal hidden" id="userManagementModal">
    <div class="modal-overlay" onclick="closeUserManagementModal()"></div>
    <div class="modal-content modal-content-large">
      <div class="modal-header">
        <h3>用户管理</h3>
        <button class="modal-close" onclick="closeUserManagementModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="user-management-toolbar">
          <button class="btn btn-primary" onclick="openAddUserModal()">新增用户</button>
        </div>
        <div class="user-list-container">
          <div class="user-list-header">
            <div class="user-list-header-cell user-list-header-info">用户信息</div>
            <div class="user-list-header-cell user-list-header-username">账号</div>
            <div class="user-list-header-cell user-list-header-time">创建时间</div>
            <div class="user-list-header-cell user-list-header-status">状态</div>
            <div class="user-list-header-cell user-list-header-actions">操作</div>
          </div>
          <div class="user-list" id="userList"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeUserManagementModal()">关闭</button>
      </div>
    </div>
  </div>

  <!-- 新增/编辑用户模态框 -->
  <div class="modal hidden" id="userFormModal">
    <div class="modal-overlay" onclick="closeUserFormModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="userFormTitle">新增用户</h3>
        <button class="modal-close" onclick="closeUserFormModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="userId">
        <div class="form-group">
          <label class="form-label" for="username">用户名</label>
          <input type="text" id="username" class="form-input" placeholder="请输入用户名">
        </div>
        <div class="form-group">
          <label class="form-label" for="userNickname">昵称</label>
          <input type="text" id="userNickname" class="form-input" placeholder="请输入昵称">
        </div>
        <div class="form-group">
          <label class="form-label" for="password">密码</label>
          <input type="password" id="password" class="form-input" placeholder="请输入密码">
        </div>
        <div class="form-group">
          <label class="form-label" for="confirmPassword">确认密码</label>
          <input type="password" id="confirmPassword" class="form-input" placeholder="请再次输入密码">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeUserFormModal()">取消</button>
        <button class="btn btn-primary" onclick="handleSaveUser()">保存</button>
      </div>
    </div>
  </div>

  <script>
    async function fetchJson(url, opts) {
      const res = await fetch(url, opts);
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || ('HTTP ' + res.status));
      return data;
    }

    function fmtTime(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleString();
      } catch (_) {
        return iso || '';
      }
    }

    async function ensureLogin() {
      const s = await fetchJson('/api/auth/status');
      console.log('登录状态:', s);
      if (!s.loggedIn) {
        window.location.href = '/login';
        return null;
      }
      document.getElementById('nickname').textContent = s.user?.nickname || '用户';
      const avatar = document.getElementById('avatar');
      if (s.user?.avatarUrl) {
        avatar.src = s.user.avatarUrl;
        avatar.style.background = 'transparent';
      } else {
        avatar.removeAttribute('src');
      }
      
      console.log('当前用户信息:', s.user);
      console.log('用户名:', s.user?.username);
      console.log('是否为admin:', s.user?.username === 'admin');
      
      // 检查是否是 admin 用户
      if (s.user?.username === 'admin') {
        document.body.classList.add('admin-user');
        console.log('已添加 admin-user 类');
      }
      
      return s.user;
    }

    // 用户管理相关函数
    function openUserManagementModal() {
      document.getElementById('userManagementModal').classList.remove('hidden');
      loadUsers();
    }

    function closeUserManagementModal() {
      document.getElementById('userManagementModal').classList.add('hidden');
    }

    async function loadUsers() {
      try {
        const users = await fetchJson('/api/users');
        renderUserList(users);
      } catch (err) {
        Sweetalert2.fire({
          title: '加载失败',
          text: '加载用户列表失败：' + err.message,
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
      }
    }

    function renderUserList(users) {
      const userList = document.getElementById('userList');
      userList.innerHTML = '';
      
      if (!users || users.length === 0) {
        userList.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">暂无用户</div>';
        return;
      }
      
      for (const user of users) {
        const userItem = document.createElement('div');
        userItem.className = 'user-item';
        userItem.innerHTML = `
          <div class="user-item-info">
            <div class="user-item-name">${user.nickname && user.nickname !== 'None' ? user.nickname : '未命名用户'}</div>
          </div>
          <div class="user-item-username">${user.username}</div>
          <div class="user-item-time">${formatDate(user.createdAt)}</div>
          <div class="user-item-status ${user.isActive ? 'active' : 'disabled'}">
            ${user.isActive ? '正常' : '已停用'}
          </div>
          <div class="user-item-actions">
            <button class="user-item-btn" onclick="openEditUserModal(${user.id})">编辑</button>
            <button class="user-item-btn" onclick="openResetPasswordModal(${user.id})">重置密码</button>
            ${user.username !== 'admin' ? `<button class="user-item-btn danger" onclick="toggleUserStatus(${user.id}, ${user.isActive ? 0 : 1})">${user.isActive ? '停用' : '启用'}</button>` : ''}
            ${user.username !== 'admin' ? `<button class="user-item-btn danger" onclick="deleteUser(${user.id})">删除</button>` : ''}
          </div>
        `;
        userList.appendChild(userItem);
      }
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    function openAddUserModal() {
      document.getElementById('userFormTitle').textContent = '新增用户';
      document.getElementById('userId').value = '';
      document.getElementById('username').value = '';
      document.getElementById('userNickname').value = '';
      document.getElementById('password').value = '';
      document.getElementById('confirmPassword').value = '';
      document.getElementById('userFormModal').classList.remove('hidden');
    }

    function openEditUserModal(userId) {
      document.getElementById('userFormTitle').textContent = '编辑用户';
      document.getElementById('userId').value = userId;
      
      fetchJson('/api/users/' + userId).then(user => {
        document.getElementById('username').value = user.username;
        document.getElementById('userNickname').value = (user.nickname && user.nickname !== 'None') ? user.nickname : '';
        document.getElementById('password').value = '';
        document.getElementById('confirmPassword').value = '';
        document.getElementById('userFormModal').classList.remove('hidden');
      }).catch(err => {
        Sweetalert2.fire({
          title: '加载失败',
          text: '加载用户信息失败：' + err.message,
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
      });
    }

    function closeUserFormModal() {
      document.getElementById('userFormModal').classList.add('hidden');
    }

    async function handleSaveUser() {
      const userId = document.getElementById('userId').value;
      const username = document.getElementById('username').value.trim();
      const nickname = document.getElementById('userNickname').value.trim();
      const password = document.getElementById('password').value.trim();
      const confirmPassword = document.getElementById('confirmPassword').value.trim();
      
      if (!username) {
        Sweetalert2.fire({
          title: '验证失败',
          text: '用户名不能为空',
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
        return;
      }
      
      if (password && password !== confirmPassword) {
        Sweetalert2.fire({
          title: '验证失败',
          text: '两次输入的密码不一致',
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
        return;
      }
      
      if (userId && !password) {
        Sweetalert2.fire({
          title: '验证失败',
          text: '编辑用户时必须输入密码',
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
        return;
      }
      
      try {
        const userData = {
          username: username,
          nickname: nickname
        };
        
        if (password) {
          userData.password = password;
        }
        
        if (userId) {
          await fetchJson('/api/users/' + userId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(userData)
          });
        } else {
          await fetchJson('/api/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(userData)
          });
        }
        
        closeUserFormModal();
        loadUsers();
        
        Sweetalert2.fire({
          title: '保存成功',
          text: userId ? '用户信息已更新' : '用户已创建',
          icon: 'success',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
      } catch (err) {
        Sweetalert2.fire({
          title: '保存失败',
          text: err.message,
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
      }
    }

    async function deleteUser(userId) {
      Sweetalert2.fire({
        title: '确认删除',
        text: '确定要删除该用户吗？此操作不可恢复。',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        confirmButtonColor: '#e53935',
        cancelButtonColor: '#666',
        width: '320px'
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            await fetchJson('/api/users/' + userId, {
              method: 'DELETE'
            });
            loadUsers();
            
            Sweetalert2.fire({
              title: '删除成功',
              text: '用户已删除',
              icon: 'success',
              confirmButtonColor: '#667eea',
              width: '320px'
            });
          } catch (err) {
            Sweetalert2.fire({
              title: '删除失败',
              text: err.message,
              icon: 'error',
              confirmButtonColor: '#667eea',
              width: '320px'
            });
          }
        }
      });
    }

    async function toggleUserStatus(userId, isActive) {
      try {
        await fetchJson('/api/users/' + userId + '/status', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ isActive })
        });
        loadUsers();
        
        Sweetalert2.fire({
          title: '操作成功',
          text: isActive ? '用户已启用' : '用户已停用',
          icon: 'success',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
      } catch (err) {
        Sweetalert2.fire({
          title: '操作失败',
          text: err.message,
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
      }
    }

    async function openResetPasswordModal(userId) {
      Sweetalert2.fire({
        title: '重置密码',
        text: '确定要重置该用户的密码吗？',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        confirmButtonColor: '#667eea',
        cancelButtonColor: '#666',
        width: '320px'
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            await fetchJson('/api/users/' + userId + '/reset-password', {
              method: 'POST'
            });
            
            Sweetalert2.fire({
              title: '重置成功',
              text: '密码已重置为：123456',
              icon: 'success',
              confirmButtonColor: '#667eea',
              width: '320px'
            });
          } catch (err) {
            Sweetalert2.fire({
              title: '重置失败',
              text: err.message,
              icon: 'error',
              confirmButtonColor: '#667eea',
              width: '320px'
            });
          }
        }
      });
    }

    // 页面加载时检查登录状态
    document.addEventListener('DOMContentLoaded', async () => {
      await ensureLogin();
    });

    // 拖拽排序相关变量
    let draggedGraphId = null;
    let draggedElement = null;
    let originalGraphs = [];
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;
    let currentIndicator = null;
    let insertBeforeId = null;

    function renderCards(list) {
      const grid = document.getElementById('grid');
      const empty = document.getElementById('empty');
      grid.innerHTML = '';
      originalGraphs = list;
      if (!list || list.length === 0) {
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';
      for (const g of list) {
        const card = document.createElement('div');
        card.className = 'card';
        card.dataset.graphId = g.id;
        card.dataset.sortOrder = g.sort_order;
        // 阻止点击菜单时触发卡片跳转
        card.addEventListener('click', (e) => {
          if (isDragging) {
            e.preventDefault();
            e.stopPropagation();
            return;
          }
          if (!e.target.closest('.card-more') && !e.target.closest('.dropdown-menu') && !e.target.closest('.drag-handle')) {
            window.location.href = '/g/' + g.id;
          }
        });
        const first = (g.name || 'G').trim().slice(0,1).toUpperCase();
        const thumbHtml = (g.thumbnail && g.thumbnail.startsWith('data:image'))
          ? `<img src="${g.thumbnail}" style="width:100%;height:180px;object-fit:contain;display:block;background:#fff;" alt="">`
          : `<div class="thumb">${first}</div>`;
        card.innerHTML = `
          ${thumbHtml}
          <!-- 拖拽手柄 -->
          <div class="drag-handle" data-graph-id="${g.id}" title="拖拽排序">
            <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
              <path d="M11 18c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2zm-2-8c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 4c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
            </svg>
          </div>
          <!-- 更多按钮 -->
          <button class="card-more" data-graph-id="${g.id}" title="更多操作">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <circle cx="12" cy="6" r="2"/>
              <circle cx="12" cy="12" r="2"/>
              <circle cx="12" cy="18" r="2"/>
            </svg>
          </button>
          <div class="card-body">
            <div class="name">${g.name || '未命名关系图'}</div>
            <div class="meta">创建时间：${fmtTime(g.createdAt)}</div>
          </div>
        `;

        // 添加拖拽事件
        const dragHandle = card.querySelector('.drag-handle');
        dragHandle.addEventListener('mousedown', (e) => {
          e.stopPropagation();
          e.preventDefault();
          dragStartX = e.clientX;
          dragStartY = e.clientY;
          setTimeout(() => startDrag(g.id, card), 0);
        });

        grid.appendChild(card);
      }
    }

    function createDragIndicator() {
      const indicator = document.createElement('div');
      indicator.className = 'drag-indicator';
      return indicator;
    }

    function showInsertIndicator(card, position) {
  if (!isDragging) {
    console.log('Not dragging, skipping indicator');
    return;
  }
  
  console.log('showInsertIndicator:', card ? card.dataset.graphId : null, position);
  
  // 移除之前的指示器
  if (currentIndicator) {
    currentIndicator.remove();
    currentIndicator = null;
  }

  if (!card) {
    insertBeforeId = null;
    return;
  }

  // 创建新的指示器
  currentIndicator = createDragIndicator();
  card.style.position = 'relative';
  
  if (position === 'left') {
    currentIndicator.classList.add('drag-indicator-left');
    insertBeforeId = parseInt(card.dataset.graphId);
    console.log('Insert before:', insertBeforeId);
  } else {
    currentIndicator.classList.add('drag-indicator-right');
    insertBeforeId = parseInt(card.dataset.graphId) + 10000; // 表示插入到后面
    console.log('Insert after:', insertBeforeId - 10000);
  }
  
  card.appendChild(currentIndicator);
  setTimeout(() => {
    if (currentIndicator) {
      currentIndicator.classList.add('show');
    }
  }, 10);
}

    function startDrag(graphId, element) {
      isDragging = true;
      draggedGraphId = graphId;
      draggedElement = element;
      element.classList.add('dragging');

      function onMouseMove(e) {
        if (!isDragging) return;
        
        element.style.position = 'fixed';
        element.style.zIndex = '10000';
        element.style.left = (e.clientX - element.offsetWidth / 2) + 'px';
        element.style.top = (e.clientY - element.offsetHeight / 2) + 'px';

        // 计算拖拽距离
        const dragDistance = Math.sqrt(
          Math.pow(e.clientX - dragStartX, 2) + 
          Math.pow(e.clientY - dragStartY, 2)
        );

        // 只有当拖拽距离超过10px时才显示插入位置
        if (dragDistance > 10) {
          const cards = document.querySelectorAll('.card:not(.dragging)');
          let targetCard = null;
          let insertPosition = 'top';

          // 找到鼠标下方的卡片
          cards.forEach(card => {
            const rect = card.getBoundingClientRect();
            if (e.clientX >= rect.left && e.clientX <= rect.right &&
                e.clientY >= rect.top && e.clientY <= rect.bottom) {
              targetCard = card;
              // 根据鼠标在卡片中的位置决定插入左边还是右边
              const cardCenterX = rect.left + rect.width / 2;
              insertPosition = e.clientX < cardCenterX ? 'left' : 'right';
              console.log('Mouse over card:', card.dataset.graphId, 'position:', insertPosition);
            }
          });

          showInsertIndicator(targetCard, insertPosition);
        }
      }

      function onMouseUp(e) {
        console.log('onMouseUp - isDragging:', isDragging);
        
        if (!isDragging) return;
        
        // 阻止事件传播，防止触发点击事件
        e.preventDefault();
        e.stopPropagation();
        
        // 延迟设置 isDragging 为 false，确保点击事件处理程序能够检查到
        setTimeout(() => {
          isDragging = false;
        }, 100);
        
        // 先移除事件监听器
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        document.removeEventListener('mouseleave', onMouseUp);

        // 恢复卡片样式
        element.classList.remove('dragging');
        element.style.position = '';
        element.style.zIndex = '';
        element.style.left = '';
        element.style.top = '';

        // 移除指示器
        if (currentIndicator) {
          currentIndicator.remove();
          currentIndicator = null;
        }

        // 计算拖拽距离
        const dragDistance = Math.sqrt(
          Math.pow(e.clientX - dragStartX, 2) + 
          Math.pow(e.clientY - dragStartY, 2)
        );
        
        console.log('Drag distance:', dragDistance);
        console.log('insertBeforeId:', insertBeforeId);

        // 如果拖拽距离小于10px，认为是点击，不执行排序
        if (dragDistance < 10) {
          console.log('Drag distance too small, treating as click');
          insertBeforeId = null;
          return;
        }

        // 执行排序
        if (insertBeforeId !== null) {
          console.log('Executing reorder...');
          const allCards = Array.from(document.querySelectorAll('.card'));
          
          if (insertBeforeId > 1000) {
            // 插入到目标卡片后面
            const targetCardId = insertBeforeId - 10000;
            const targetCard = allCards.find(card => parseInt(card.dataset.graphId) === targetCardId);
            if (targetCard) {
              const targetIndex = allCards.findIndex(card => card === targetCard);
              console.log('Inserting after card', targetCardId, 'at index', targetIndex + 1);
              reorderGraphs(draggedGraphId, targetIndex + 1);
            } else {
              console.log('Target card not found:', targetCardId);
            }
          } else {
            // 插入到目标卡片前面
            const targetCard = allCards.find(card => parseInt(card.dataset.graphId) === insertBeforeId);
            if (targetCard) {
              const targetIndex = allCards.findIndex(card => card === targetCard);
              console.log('Inserting before card', insertBeforeId, 'at index', targetIndex);
              reorderGraphs(draggedGraphId, targetIndex);
            } else {
              console.log('Target card not found:', insertBeforeId);
            }
          }
          
          insertBeforeId = null;
        } else {
          console.log('No insert position found');
        }
      }

      // 添加事件监听器
      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp);
      document.addEventListener('mouseleave', onMouseUp); // 防止鼠标移出窗口
    }

    async function reorderGraphs(movedGraphId, newIndex) {
      // 从DOM获取当前所有卡片的顺序
      const cards = Array.from(document.querySelectorAll('.card'));
      
      // 找到移动的图在当前列表中的位置
      const oldIndex = cards.findIndex(card => parseInt(card.dataset.graphId) === movedGraphId);
      if (oldIndex === -1 || oldIndex === newIndex) return;

      // 创建新的排序数组
      const newList = [...cards];
      const [movedCard] = newList.splice(oldIndex, 1);
      newList.splice(newIndex, 0, movedCard);

      // 更新排序值
      const updatedGraphs = newList.map((card, index) => ({
        id: parseInt(card.dataset.graphId),
        sort_order: index
      }));

      console.log('Reordering graphs:', updatedGraphs);

      try {
        await fetchJson('/api/graphs/sort-orders', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ graphs: updatedGraphs })
        });

        // 刷新列表
        loadGraphs();
      } catch (err) {
        console.error('更新排序失败:', err);
        Swal.fire({
          title: '排序失败',
          text: '更新关系图排序失败，请重试',
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '280px',
          customClass: {
            title: 'swal2-title-sm',
            content: 'swal2-content-sm',
            confirmButton: 'swal2-btn-sm'
          }
        });
      }
    }

    async function loadGraphs() {
      const list = await fetchJson('/api/graphs');
      console.log('Loaded graphs:', list);
      renderCards(list);
    }

    // 菜单相关逻辑
    let activeMenuId = null;
    let activeMenuButton = null;

    function closeMenu() {
      const container = document.getElementById('dropdownMenuContainer');
      container.innerHTML = '';
      activeMenuId = null;
      activeMenuButton = null;
    }

    function showMenu(graphId, button) {
      closeMenu();
      const btn = button || document.querySelector('.card-more[data-graph-id="' + graphId + '"]');
      if (btn) {
        // 创建菜单
        const container = document.getElementById('dropdownMenuContainer');
        container.innerHTML = `
          <div class="dropdown-menu show" id="menu-${graphId}">
            <div class="dropdown-item" onclick="event.stopPropagation(); handleMenuAction('rename', ${graphId})">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 20h9M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
              </svg>
              重命名
            </div>
            <div class="dropdown-item" onclick="event.stopPropagation(); handleMenuAction('copy', ${graphId})">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
              </svg>
              复制
            </div>
            <div class="dropdown-item dropdown-with-select" onclick="event.stopPropagation();">
              <div class="dropdown-select-wrapper">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                <span>导出图片</span>
              </div>
              <select class="export-format-select" id="format-${graphId}" onchange="event.stopPropagation();">
                <option value="jpg">JPG</option>
                <option value="png">PNG</option>
              </select>
              <button class="export-btn" onclick="event.stopPropagation(); handleExport(${graphId})">导出</button>
            </div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item danger" onclick="event.stopPropagation(); handleMenuAction('delete', ${graphId})">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
              </svg>
              删除
            </div>
          </div>
        `;

        // 计算菜单位置
        const menu = document.getElementById('menu-' + graphId);
        const rect = btn.getBoundingClientRect();
        menu.style.left = rect.right - 150 + 'px';
        menu.style.top = rect.bottom + 5 + 'px';
        activeMenuId = graphId;
        activeMenuButton = btn;
      }
    }

    // 点击事件处理
    document.addEventListener('click', (e) => {
      // 处理更多按钮点击
      const moreBtn = e.target.closest('.card-more');
      if (moreBtn) {
        e.stopPropagation();
        const graphId = moreBtn.dataset.graphId;
        showMenu(graphId, moreBtn);
        return;
      }

      // 处理菜单内的点击
      if (activeMenuId) {
        const menu = document.getElementById('menu-' + activeMenuId);
        // 如果点击不在菜单内，关闭菜单
        if (menu && !menu.contains(e.target)) {
          closeMenu();
        }
      }
    });

    // ESC键关闭菜单
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && activeMenuId) {
        closeMenu();
      }
    });



    // 全局菜单操作处理函数
    window.handleMenuAction = function(action, graphId) {
      console.log('handleMenuAction called:', action, graphId);
      // 删除操作先不关闭菜单，等确认后再关闭
      if (action !== 'delete') {
        closeMenu();
      }

      if (action === 'delete') {
        console.log('Showing delete confirmation modal');
        Swal.fire({
          title: '确认删除',
          text: '确定要删除这个关系图吗？此操作不可恢复。',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#667eea',
          cancelButtonColor: '#666',
          confirmButtonText: '确定删除',
          cancelButtonText: '取消',
          width: '300px',
          customClass: {
            title: 'swal2-title-sm',
            content: 'swal2-content-sm',
            confirmButton: 'swal2-btn-sm',
            cancelButton: 'swal2-btn-sm'
          }
        }).then((result) => {
          if (result.isConfirmed) {
            console.log('Delete confirmed, graphId:', graphId);
            closeMenu();
            fetchJson('/api/graphs/' + graphId, { method: 'DELETE' })
              .then(() => {
                loadGraphs();
                Swal.fire({
                  title: '删除成功',
                  text: '关系图已成功删除',
                  icon: 'success',
                  confirmButtonColor: '#667eea',
                  width: '280px',
                  customClass: {
                    title: 'swal2-title-sm',
                    content: 'swal2-content-sm',
                    confirmButton: 'swal2-btn-sm'
                  }
                });
              })
              .catch(err => {
                Swal.fire({
                  title: '删除失败',
                  text: err.message,
                  icon: 'error',
                  confirmButtonColor: '#667eea',
                  width: '280px',
                  customClass: {
                    title: 'swal2-title-sm',
                    content: 'swal2-content-sm',
                    confirmButton: 'swal2-btn-sm'
                  }
                });
              });
          } else {
            console.log('Delete cancelled');
            closeMenu();
          }
        });
      } else if (action === 'rename') {
        Swal.fire({
          title: '重命名',
          input: 'text',
          inputPlaceholder: '请输入新的关系图名称',
          showCancelButton: true,
          confirmButtonColor: '#667eea',
          cancelButtonColor: '#666',
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          width: '300px',
          customClass: {
            title: 'swal2-title-sm',
            confirmButton: 'swal2-btn-sm',
            cancelButton: 'swal2-btn-sm'
          }
        }).then((result) => {
          if (result.isConfirmed && result.value && result.value.trim()) {
            fetchJson('/api/graphs/' + graphId, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name: result.value.trim() })
            }).then(() => {
              loadGraphs();
              Swal.fire({
                title: '重命名成功',
                text: '关系图名称已更新',
                icon: 'success',
                confirmButtonColor: '#667eea',
                width: '280px',
                customClass: {
                  title: 'swal2-title-sm',
                  content: 'swal2-content-sm',
                  confirmButton: 'swal2-btn-sm'
                }
              });
            }).catch(err => {
              Swal.fire({
                title: '重命名失败',
                text: err.message,
                icon: 'error',
                confirmButtonColor: '#667eea',
                width: '280px',
                customClass: {
                  title: 'swal2-title-sm',
                  content: 'swal2-content-sm',
                  confirmButton: 'swal2-btn-sm'
                }
              });
            });
          }
        });
      } else if (action === 'copy') {
        Swal.fire({
          title: '复制关系图',
          input: 'text',
          inputValue: '副本 - ',
          inputPlaceholder: '请输入复制后的名称',
          showCancelButton: true,
          confirmButtonColor: '#667eea',
          cancelButtonColor: '#666',
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          width: '300px',
          customClass: {
            title: 'swal2-title-sm',
            confirmButton: 'swal2-btn-sm',
            cancelButton: 'swal2-btn-sm'
          }
        }).then((result) => {
          if (result.isConfirmed && result.value && result.value.trim()) {
            fetchJson('/api/graphs', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name: result.value.trim() })
            }).then(() => {
              loadGraphs();
              Swal.fire({
                title: '复制成功',
                text: '关系图已复制',
                icon: 'success',
                confirmButtonColor: '#667eea',
                width: '280px',
                customClass: {
                  title: 'swal2-title-sm',
                  content: 'swal2-content-sm',
                  confirmButton: 'swal2-btn-sm'
                }
              });
            }).catch(err => {
              Swal.fire({
                title: '复制失败',
                text: err.message,
                icon: 'error',
                confirmButtonColor: '#667eea',
                width: '280px',
                customClass: {
                  title: 'swal2-title-sm',
                  content: 'swal2-content-sm',
                  confirmButton: 'swal2-btn-sm'
                }
              });
            });
          }
        });
      }
    };

    // 导出图片函数 - 静默导出，不打开新窗口
    window.handleExport = async function(graphId) {
      console.log('开始导出，graphId:', graphId);
      const format = document.getElementById('format-' + graphId)?.value || 'png';
      console.log('导出格式:', format);

      try {
        // 获取关系图数据
        console.log('正在获取数据...');
        const [nodes, edges] = await Promise.all([
          fetchJson('/api/nodes?graphId=' + graphId),
          fetchJson('/api/edges?graphId=' + graphId)
        ]);
        console.log('获取到数据:', nodes.length, '节点', edges.length, '边');

        // 在隐藏画布上渲染并导出
        const canvas = document.getElementById('exportCanvas');
        const ctx = canvas.getContext('2d');

        // 计算画布范围
        let minX = 50, minY = 50, maxX = 800, maxY = 600;
        if (nodes.length > 0) {
          minX = Math.min(...nodes.map(n => n.x - (n.radius || 20))) - 50;
          minY = Math.min(...nodes.map(n => n.y - (n.radius || 20))) - 50;
          maxX = Math.max(...nodes.map(n => n.x + (n.radius || 20))) + 50;
          maxY = Math.max(...nodes.map(n => n.y + (n.radius || 20))) + 50;
        }
        const width = Math.max(800, maxX - minX);
        const height = Math.max(600, maxY - minY);
        canvas.width = width;
        canvas.height = height;

        // 填充背景 - PNG使用透明背景，JPG使用白色背景
        if (format === 'jpg') {
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, width, height);
        }

        // 缩放和平移
        ctx.translate(-minX, -minY);

        // 绘制边
        edges.forEach(edge => {
          const source = nodes.find(n => n.id === edge.sourceId);
          const target = nodes.find(n => n.id === edge.targetId);
          if (source && target) {
            ctx.beginPath();
            ctx.moveTo(source.x, source.y);
            const bendPoints = Array.isArray(edge.bendPoints) ? edge.bendPoints : [];
            bendPoints.forEach(p => ctx.lineTo(p.x, p.y));
            ctx.lineTo(target.x, target.y);
            ctx.strokeStyle = edge.color || '#999';
            ctx.lineWidth = 2;
            ctx.stroke();

            // 绘制标签
            if (edge.label) {
              ctx.font = '12px sans-serif';
              ctx.fillStyle = edge.color || '#666';
              const midX = bendPoints.length > 0 ? bendPoints[0].x : (source.x + target.x) / 2;
              const midY = bendPoints.length > 0 ? bendPoints[0].y : (source.y + target.y) / 2;
              ctx.fillText(edge.label, midX - 20, midY - 5);
            }
          }
        });

        // 绘制节点
        nodes.forEach(node => {
          const radius = node.radius || 30;
          ctx.beginPath();
          ctx.arc(node.x, node.y, radius, 0, Math.PI * 2);
          ctx.fillStyle = node.color || '#667eea';
          ctx.fill();
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.stroke();

          // 绘制文字
          ctx.fillStyle = '#fff';
          ctx.font = 'bold 14px sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText((node.name || '').slice(0, 4), node.x, node.y);
        });

        // 导出图片
        const mimeType = format === 'jpg' ? 'image/jpeg' : 'image/png';
        const dataUrl = canvas.toDataURL(mimeType, 0.9);
        const link = document.createElement('a');
        link.download = `graph-${graphId}-${Date.now()}.${format}`;
        link.href = dataUrl;
        link.click();

        console.log('图片导出成功');
        closeMenu();
      } catch (err) {
        console.error('导出失败:', err);
        Swal.fire({
          title: '导出失败',
          text: err.message,
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '280px',
          customClass: {
            title: 'swal2-title-sm',
            content: 'swal2-content-sm',
            confirmButton: 'swal2-btn-sm'
          }
        });
        closeMenu();
      }
    };

    document.getElementById('btnCreate').addEventListener('click', async () => {
      // 弹出输入框让用户输入关系图名称和描述
      const { value: formValues } = await Swal.fire({
        title: '新建关系图',
        html: `
          <div style="width: 100%; max-width: 100%; overflow: hidden;">
            <div style="margin-bottom: 10px;">
              <label style="font-size: 13px; font-weight: 500; color: #333; display: block; margin-bottom: 5px; text-align: left;">图名</label>
              <input type="text" id="graphName" placeholder="请输入关系图名称" style="width: 100%; box-sizing: border-box; padding: 8px; font-size: 13px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 13px; font-weight: 500; color: #333; display: block; margin-bottom: 5px; text-align: left;">描述</label>
              <textarea id="graphDescription" placeholder="请输入关系图描述（可选）" style="width: 100%; box-sizing: border-box; padding: 8px; font-size: 13px; min-height: 60px; resize: vertical; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            </div>
          </div>
        `,
        showCancelButton: true,
        confirmButtonColor: '#667eea',
        cancelButtonColor: '#666',
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        customClass: {
          popup: 'swal2-popup-wide',
          title: 'swal2-title-sm',
          confirmButton: 'swal2-btn-sm',
          cancelButton: 'swal2-btn-sm'
        },
        preConfirm: () => {
          const name = document.getElementById('graphName').value.trim();
          const description = document.getElementById('graphDescription').value.trim();
          if (!name) {
            Swal.showValidationMessage('请输入关系图名称');
            return false;
          }
          return { name, description };
        }
      });

      if (formValues) {
        try {
          const g = await fetchJson('/api/graphs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: formValues.name, description: formValues.description })
          });
          // 刷新关系图列表
          loadGraphs();
          // 显示成功提示
          Swal.fire({
            title: '创建成功',
            text: '关系图已创建',
            icon: 'success',
            confirmButtonColor: '#667eea',
            width: '280px',
            customClass: {
              title: 'swal2-title-sm',
              content: 'swal2-content-sm',
              confirmButton: 'swal2-btn-sm'
            }
          });
        } catch (err) {
          Swal.fire({
            title: '创建失败',
            text: err.message,
            icon: 'error',
            confirmButtonColor: '#667eea',
            width: '280px',
            customClass: {
              title: 'swal2-title-sm',
              content: 'swal2-content-sm',
              confirmButton: 'swal2-btn-sm'
            }
          });
        }
      }
    });

    // 处理用户下拉菜单
    const userInfo = document.getElementById('userInfo');
    const userDropdown = document.getElementById('userDropdown');

    console.log('User info element:', userInfo);
    console.log('User dropdown element:', userDropdown);

    // 切换用户下拉菜单
    userInfo.addEventListener('click', (e) => {
      console.log('User info clicked!');
      e.stopPropagation();
      // 直接切换显示状态，不依赖于当前值的判断
      console.log('Current dropdown hidden:', userDropdown.classList.contains('hidden'));
      if (userDropdown.classList.contains('hidden')) {
        console.log('Showing dropdown');
        // 计算用户信息的位置，将下拉菜单定位到用户信息的下方
        const rect = userInfo.getBoundingClientRect();
        console.log('User info rect:', rect);
        console.log('Window scrollY:', window.scrollY);
        console.log('Window scrollX:', window.scrollX);
        console.log('Window innerWidth:', window.innerWidth);
        
        const topPosition = rect.bottom + window.scrollY + 8;
        const rightPosition = window.innerWidth - rect.right + window.scrollX;
        
        console.log('Calculated top:', topPosition);
        console.log('Calculated right:', rightPosition);
        
        userDropdown.style.top = topPosition + 'px';
        userDropdown.style.right = rightPosition + 'px';
        
        // 强制设置下拉菜单的样式，确保它可见
        userDropdown.style.display = 'block';
        userDropdown.style.opacity = '1';
        userDropdown.style.visibility = 'visible';
        
        userDropdown.classList.remove('hidden');
        
        // 打印下拉菜单的最终样式
        console.log('Dropdown computed style:');
        console.log('  display:', getComputedStyle(userDropdown).display);
        console.log('  opacity:', getComputedStyle(userDropdown).opacity);
        console.log('  visibility:', getComputedStyle(userDropdown).visibility);
        console.log('  top:', getComputedStyle(userDropdown).top);
        console.log('  right:', getComputedStyle(userDropdown).right);
        console.log('  z-index:', getComputedStyle(userDropdown).zIndex);
      } else {
        console.log('Hiding dropdown');
        userDropdown.classList.add('hidden');
        // 强制设置下拉菜单的样式，确保它被隐藏
        userDropdown.style.display = 'none';
        userDropdown.style.opacity = '0';
        userDropdown.style.visibility = 'hidden';
      }
      console.log('Updated dropdown hidden:', userDropdown.classList.contains('hidden'));
    });

    // 点击页面其他地方关闭下拉菜单
    document.addEventListener('click', () => {
      if (!userDropdown.classList.contains('hidden')) {
        console.log('Hiding dropdown on document click');
        userDropdown.classList.add('hidden');
        // 强制设置下拉菜单的样式，确保它被隐藏
        userDropdown.style.display = 'none';
        userDropdown.style.opacity = '0';
        userDropdown.style.visibility = 'hidden';
      }
    });

    // 个人中心导航
    window.navigateToProfile = () => {
      userDropdown.classList.add('hidden');
      // 强制设置下拉菜单的样式，确保它被隐藏
      userDropdown.style.display = 'none';
      userDropdown.style.opacity = '0';
      userDropdown.style.visibility = 'hidden';
      // 这里可以添加个人中心页面的导航逻辑
      Swal.fire({
        title: '个人中心',
        text: '个人中心功能正在开发中',
        icon: 'info',
        confirmButtonColor: '#667eea',
        width: '280px',
        customClass: {
          title: 'swal2-title-sm',
          content: 'swal2-content-sm',
          confirmButton: 'swal2-btn-sm'
        }
      });
    };

    // 退出登录处理
    window.handleLogout = async () => {
      userDropdown.classList.add('hidden');
      // 强制设置下拉菜单的样式，确保它被隐藏
      userDropdown.style.display = 'none';
      userDropdown.style.opacity = '0';
      userDropdown.style.visibility = 'hidden';
      await fetchJson('/api/auth/logout', { method: 'POST' });
      window.location.href = '/login';
    };

    function openChangePasswordModal() {
      document.getElementById('changePasswordModal').classList.remove('hidden');
    }

    function closeChangePasswordModal() {
      document.getElementById('changePasswordModal').classList.add('hidden');
      // 清空表单
      document.getElementById('currentPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    }

    async function handleChangePassword() {
      const currentPassword = document.getElementById('currentPassword').value.trim();
      const newPassword = document.getElementById('newPassword').value.trim();
      const confirmPassword = document.getElementById('changeConfirmPassword').value.trim();
      
      if (!currentPassword || !newPassword || !confirmPassword) {
        Sweetalert2.fire({
          title: '修改失败',
          text: '所有密码字段不能为空',
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
        return;
      }
      
      if (newPassword !== confirmPassword) {
        Sweetalert2.fire({
          title: '修改失败',
          text: '两次输入的新密码不一致',
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
        return;
      }
      
      try {
        await fetchJson('/api/auth/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ currentPassword, newPassword })
        });
        
        Sweetalert2.fire({
          title: '修改成功',
          text: '密码已成功修改',
          icon: 'success',
          confirmButtonColor: '#667eea',
          width: '320px'
        }).then(() => {
          closeChangePasswordModal();
        });
      } catch (err) {
        Sweetalert2.fire({
          title: '修改失败',
          text: err.message,
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
      }
    }

    // 搜索功能
    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('searchInput');
      const searchIcon = document.getElementById('searchIcon');
      
      console.log('Search input element:', searchInput);
      console.log('Search icon element:', searchIcon);
      
      if (!searchInput || !searchIcon) {
        console.error('Search elements not found');
        return;
      }
      
      // 执行搜索
      function performSearch() {
        const searchTerm = searchInput.value.trim().toLowerCase();
        console.log('Performing search for:', searchTerm);
        
        // 获取所有关系图卡片
        const graphCards = document.querySelectorAll('.card');
        console.log('Found graph cards:', graphCards.length);
        
        graphCards.forEach(card => {
          // 获取卡片标题
          const titleElement = card.querySelector('.name');
          if (titleElement) {
            const title = titleElement.textContent.trim().toLowerCase();
            console.log('Card title:', title);
            
            // 模糊匹配
            if (title.includes(searchTerm)) {
              card.style.display = 'block';
            } else {
              card.style.display = 'none';
            }
          }
        });
      }
      
      // 回车搜索
      searchInput.addEventListener('keypress', (e) => {
        console.log('Key pressed:', e.key);
        if (e.key === 'Enter') {
          performSearch();
        }
      });
      
      // 点击搜索图标搜索
      searchIcon.addEventListener('click', () => {
        console.log('Search icon clicked');
        performSearch();
      });
    });

    ensureLogin().then(u => {
      console.log('ensureLogin result:', u);
      if (u) loadGraphs();
    });
  </script>
</body>
</html>


