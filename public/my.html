<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>脉图：让关系，一目了然</title>
  <link rel="stylesheet" href="/styles.css" />
  <link rel="stylesheet" href="/my.css" />
</head>
<body>
  <div class="page">
    <!-- 左侧边栏 -->
    <div class="sidebar">
      <div class="logo">
        <img src="images/logo.png" alt="Logo">
        <div class="logo-text-container">
          <div class="logo-text-cn">脉图</div>
          <div class="logo-text-en">MindMaple</div>
        </div>
      </div>
      <button id="btnCreate" class="create-btn">+&nbsp;&nbsp;&nbsp;新建图表</button>
      <!-- 功能菜单 -->
      <div class="feature-menu">
        <div class="feature-item" onclick="showComingSoon()">
          <div class="feature-icon">📋</div>
          <div class="feature-text">模版广场</div>
          <div class="feature-badge hot">HOT</div>
        </div>
        <div class="feature-item" onclick="showComingSoon()">
          <div class="feature-icon">👥</div>
          <div class="feature-text">协作</div>
        </div>
      </div>
      <!-- 图表类型选择面板 -->
      <div id="chartTypePanel" class="chart-type-panel hidden">
        <div class="chart-type-section">
          <div class="chart-type-section-title">基础图表</div>
          <div class="chart-type-grid">
            <div class="chart-type-item" data-type="relationship">
              <div class="chart-type-icon">⚪</div>
              <div class="chart-type-name">关系图</div>
            </div>
            <div class="chart-type-item" data-type="flow">
              <div class="chart-type-icon">⬅</div>
              <div class="chart-type-name">流程图</div>
            </div>
            <div class="chart-type-item disabled" data-type="mindmap">
              <div class="chart-type-icon">🌳</div>
              <div class="chart-type-name">思维导图</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 右侧内容区 -->
    <div class="main-content">
      <!-- 右侧顶部栏 -->
      <div class="header">
        <div class="header-left">
          <div class="search-box">
            <input type="text" class="search-input" id="searchInput" placeholder="搜索关系图..." />
            <div class="search-icon" id="searchIcon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
            </div>
          </div>
        </div>
        <div class="header-right">
          <!-- 用户信息 -->
          <div class="user-menu">
            <div class="user-info" id="userInfo">
              <span id="nickname" class="user-name">未登录</span>
              <img id="avatar" class="avatar" alt="" />
            </div>
          </div>
        </div>
      </div>

      <!-- 右侧内容区 -->
      <div class="content">
        <div class="content-header">
          <!-- 分组切换和管理功能 -->
          <div class="group-section">
            <div id="groupTabs" class="group-tabs">
              <div class="group-tab active" data-group-id="all">全部</div>
            </div>
            <button id="btnManageGroups" class="group-manage-btn">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"/>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
              </svg>
              管理分组
            </button>
          </div>
        </div>
        <div id="grid" class="grid"></div>
        <div id="empty" class="empty" style="display:none;">还没有图表，先创建一个吧。</div>
      </div>
    </div>
  </div>

  <!-- 隐藏的画布用于导出 -->
  <canvas id="exportCanvas" style="display:none;"></canvas>

  <!-- 全局下拉菜单容器 -->
  <div id="dropdownMenuContainer"></div>

  <!-- 用户下拉菜单 -->
  <div class="dropdown-menu user-dropdown hidden" id="userDropdown">
    <div class="dropdown-item" onclick="navigateToProfile()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
        <circle cx="12" cy="7" r="4"/>
      </svg>
      个人中心
    </div>
    <div class="dropdown-item admin-only" onclick="openUserManagementModal()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <path d="M23 21v-2a4 4 0 0 0-4-4h-3"/>
        <circle cx="17" cy="7" r="4"/>
      </svg>
      用户管理
    </div>
    <div class="dropdown-item" onclick="openChangePasswordModal()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
      </svg>
      修改密码
    </div>
    <div class="dropdown-divider"></div>
    <div class="dropdown-item" onclick="handleLogout()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
        <polyline points="16 17 21 12 16 7"/>
        <line x1="21" y1="12" x2="9" y2="12"/>
      </svg>
      退出登录
    </div>
  </div>

  <!-- 分组管理模态框 -->
  <div class="group-modal hidden" id="groupManagementModal">
    <div class="group-modal-overlay" onclick="closeGroupManagementModal()"></div>
    <div class="group-modal-content">
      <div class="group-modal-header">
        <h3>管理分组</h3>
        <button class="group-modal-close" onclick="closeGroupManagementModal()">&times;</button>
      </div>
      <div class="group-modal-body">
        <div class="group-list-header">
          <h4 class="group-list-title">我的分组</h4>
          <button class="group-add-btn" onclick="openAddGroupModal()">+ 添加分组</button>
        </div>
        <div class="group-list-body" id="groupListBody"></div>
      </div>
      <div class="group-modal-footer">
        <button class="btn btn-secondary" onclick="closeGroupManagementModal()">关闭</button>
      </div>
    </div>
  </div>

  <!-- SweetAlert2 -->
  <script src="sweetalert2@11.js"></script>

  <!-- 修改密码模态框 -->
  <div class="modal hidden" id="changePasswordModal">
    <div class="modal-overlay" onclick="closeChangePasswordModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3>修改密码</h3>
        <button class="modal-close" onclick="closeChangePasswordModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" for="currentPassword">当前密码</label>
          <input type="password" id="currentPassword" class="form-input" placeholder="请输入当前密码">
        </div>
        <div class="form-group">
          <label class="form-label" for="newPassword">新密码</label>
          <input type="password" id="newPassword" class="form-input" placeholder="请输入新密码">
        </div>
        <div class="form-group">
          <label class="form-label" for="changeConfirmPassword">确认新密码</label>
          <input type="password" id="changeConfirmPassword" class="form-input" placeholder="请再次输入新密码">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeChangePasswordModal()">取消</button>
        <button class="btn btn-primary" onclick="handleChangePassword()">确认修改</button>
      </div>
    </div>
  </div>

  <!-- 用户管理模态框 -->
  <div class="modal hidden" id="userManagementModal">
    <div class="modal-overlay" onclick="closeUserManagementModal()"></div>
    <div class="modal-content modal-content-large">
      <div class="modal-header">
        <h3>用户管理</h3>
        <button class="modal-close" onclick="closeUserManagementModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="user-management-toolbar">
          <button class="btn btn-primary" onclick="openAddUserModal()">新增用户</button>
        </div>
        <div class="user-list-container">
          <div class="user-list-header">
            <div class="user-list-header-cell user-list-header-info">用户信息</div>
            <div class="user-list-header-cell user-list-header-username">账号</div>
            <div class="user-list-header-cell user-list-header-time">创建时间</div>
            <div class="user-list-header-cell user-list-header-status">状态</div>
            <div class="user-list-header-cell user-list-header-actions">操作</div>
          </div>
          <div class="user-list" id="userList"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeUserManagementModal()">关闭</button>
      </div>
    </div>
  </div>

  <!-- 新增/编辑用户模态框 -->
  <div class="modal hidden" id="userFormModal">
    <div class="modal-overlay" onclick="closeUserFormModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="userFormTitle">新增用户</h3>
        <button class="modal-close" onclick="closeUserFormModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="userId">
        <div class="form-group">
          <label class="form-label" for="username">用户名</label>
          <input type="text" id="username" class="form-input" placeholder="请输入用户名">
        </div>
        <div class="form-group">
          <label class="form-label" for="userNickname">昵称</label>
          <input type="text" id="userNickname" class="form-input" placeholder="请输入昵称">
        </div>
        <div class="form-group">
          <label class="form-label" for="password">密码</label>
          <input type="password" id="password" class="form-input" placeholder="请输入密码">
        </div>
        <div class="form-group">
          <label class="form-label" for="confirmPassword">确认密码</label>
          <input type="password" id="confirmPassword" class="form-input" placeholder="请再次输入密码">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeUserFormModal()">取消</button>
        <button class="btn btn-primary" onclick="handleSaveUser()">保存</button>
      </div>
    </div>
  </div>

  <script>
    // 从服务器获取配置信息
    fetch('/api/config')
      .then(res => res.json())
      .then(config => {
        window.APP_CONFIG = config;
      })
      .catch(err => {
        console.error('获取配置失败，使用默认配置:', err);
        window.APP_CONFIG = {
          drawioUrl: 'http://localhost:8080'
        };
      });
  </script>
  <script src="/my.js"></script>
</body>
</html>


