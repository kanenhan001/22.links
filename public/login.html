<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è„‰å›¾ - è®©ç»“æ„å¯è§ï¼Œè®©å…³ç³»ä¸€ç›®äº†ç„¶</title>
  <link rel="stylesheet" href="/styles.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .login-container {
      display: flex;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
      max-width: 900px;
      width: 100%;
      min-height: 500px;
      max-height: 90vh;
    }
    .left-panel {
      flex: 1.3;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 40px 32px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    .left-panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.05)"/><circle cx="10" cy="50" r="0.5" fill="rgba(255,255,255,0.05)"/><circle cx="90" cy="30" r="0.5" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
      opacity: 0.3;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      position: relative;
      z-index: 1;
    }
    .logo-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .logo-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .logo-text {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    .slogan {
      font-size: 32px;
      font-weight: 700;
      line-height: 1.3;
      margin-bottom: 16px;
      position: relative;
      z-index: 1;
    }
    .description {
      font-size: 15px;
      line-height: 1.7;
      opacity: 0.9;
      margin-bottom: 24px;
      position: relative;
      z-index: 1;
    }
    .features {
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      z-index: 1;
    }
    .feature-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .feature-icon {
      width: 24px;
      height: 24px;
      background: rgba(255,255,255,0.2);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .feature-text {
      font-size: 14px;
      line-height: 1.6;
      opacity: 0.95;
    }
    .right-panel {
      flex: 1;
      padding: 40px 32px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .login-header {
      text-align: center;
      margin-bottom: 24px;
    }
    .login-title {
      font-size: 28px;
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
    }
    .login-subtitle {
      font-size: 14px;
      color: #999;
    }
    .login-methods {
      display: flex;
      flex-direction: column;
      gap: 24px;
      min-height: 350px;
    }
    .tab-buttons {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      border-bottom: 1px solid #e5e7eb;
    }
    .tab-button {
      padding: 12px 24px;
      background: none;
      border: none;
      font-size: 14px;
      font-weight: 600;
      color: #999;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 2px solid transparent;
    }
    .tab-button.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    .login-section {
      display: none;
      min-height: 280px;
    }
    .login-section.active {
      display: block;
    }
    .wechat-login-section {
      text-align: center;
    }
    .wechat-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 8px;
    }
    .wechat-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #fff;
    }
    .wechat-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
    }
    .wechat-desc {
      font-size: 13px;
      color: #999;
      line-height: 1.5;
      margin-bottom: 16px;
    }
    .dev-login-link {
      text-align: center;
      color: #667eea;
      font-size: 13px;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    .dev-login-link:hover {
      color: #764ba2;
      text-decoration: underline;
    }

    .qr-box {
      background: #f9fafb;
      border: 2px dashed #d1d5db;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    .qr-status {
      font-size: 14px;
      color: #666;
    }
    .qr-image {
      max-width: 160px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .qr-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 20px;
    }
    .btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(102,126,234,0.4);
    }
    .btn-secondary {
      background: #f3f4f6;
      color: #666;
    }
    .btn-secondary:hover {
      background: #e5e7eb;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    .form-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }

    .form-options {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      margin-top: 8px;
      margin-bottom: 16px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 13px;
      color: #666;
      user-select: none;
    }

    .checkbox-label input[type="checkbox"] {
      display: none;
    }

    .checkbox-label .checkmark {
      width: 16px;
      height: 16px;
      border: 1px solid #ddd;
      border-radius: 4px;
      position: relative;
      transition: all 0.2s ease;
    }

    .checkbox-label input[type="checkbox"]:checked + .checkmark {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-color: #667eea;
    }

    .checkbox-label input[type="checkbox"]:checked + .checkmark::after {
      content: 'âœ“';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-size: 12px;
      font-weight: bold;
    }

    .form-actions {
      margin-top: 8px;
      text-align: center;
    }

    .login-button {
      width: 100%;
      padding: 14px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .login-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(102,126,234,0.4);
    }
    .login-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .footer {
      text-align: center;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
    }
    .footer-text {
      font-size: 12px;
      color: #999;
    }
    @media (max-width: 768px) {
      .login-container {
        flex-direction: column;
        min-height: auto;
      }
      .left-panel {
        padding: 40px 24px;
        min-height: 300px;
      }
      .right-panel {
        padding: 40px 24px;
      }
      .slogan {
        font-size: 28px;
      }
      .logo-text {
        font-size: 24px;
      }
    }
  </style>
  <script src="sweetalert2@11.js"></script>
</head>
<body>
  <div class="login-container">
    <div class="left-panel">
      <div class="logo">
        <div class="logo-icon">
          <img src="images/logo.png" alt="è„‰å›¾">
        </div>
        <div class="logo-text">MindMaple | è„‰å›¾</div>
      </div>
      <h1 class="slogan">è®©ç»“æ„å¯è§ï¼Œè®©å…³ç³»ä¸€ç›®äº†ç„¶</h1>
      <p class="description">è„‰å›¾ï¼Œç”¨"å¯¹è±¡-å±æ€§-å…³ç³»"çš„æ–¹å¼ï¼ŒæŠŠé›¶æ•£çš„ä¿¡æ¯è¿æˆä¸€å¼ ç½‘ã€‚æŠŠè„‘å­é‡Œçš„æƒ³æ³•å˜æˆçœ‹å¾—è§çš„å›¾ï¼Œè®©ç”µè„‘ï¼ˆAIï¼‰ä¹Ÿèƒ½ç†è§£ä½ çš„ä¸šåŠ¡ï¼Œä¸ºæ•°æ®åˆ†ææä¾›åŸºç¡€ï¼Œå®ç°ç”¨æ•°æ®æŒ‡å¯¼å†³ç­–ã€‚</p>
      <div class="features">
        <div class="feature-item">
          <div class="feature-icon">ğŸ¢</div>
          <div class="feature-text">ç»„ç»‡ç»“æ„ï¼šæŠŠç»„ç»‡æ¶æ„ç”»å‡ºæ¥ï¼Œè°è´Ÿè´£ä»€ä¹ˆã€è°å‘è°æ±‡æŠ¥ï¼Œä¸€ç›®äº†ç„¶ï¼Œè®©ç®¡ç†æ›´é«˜æ•ˆ</div>
        </div>
        <div class="feature-item">
          <div class="feature-icon">ğŸ‘¤</div>
          <div class="feature-text">äººç‰©å…³ç³»ï¼šæŠŠäººç‰©å…³ç³»ç†æ¸…æ¥šï¼Œè°è®¤è¯†è°ã€è°å½±å“è°ï¼Œçœ‹å¾—æ˜æ˜ç™½ç™½ï¼Œå¸®ä½ å‘ç°è§„å¾‹</div>
        </div>
        <div class="feature-item">
          <div class="feature-icon">ğŸ“ˆ</div>
          <div class="feature-text">äº‹ä»¶å‘å±•ï¼šæŠŠäº‹æƒ…çš„å‰å› åæœè¿èµ·æ¥ï¼Œé¢„æµ‹ä¸‹ä¸€æ­¥ä¼šå‘ç”Ÿä»€ä¹ˆï¼Œæå‰è§„é¿é£é™©</div>
        </div>
        <div class="feature-item">
          <div class="feature-icon">ğŸ§ </div>
          <div class="feature-text">çŸ¥è¯†å»ºæ¨¡ï¼šè‡ªå®šä¹‰ä½ éœ€è¦çš„å¯¹è±¡å’Œå…³ç³»ï¼Œçµæ´»é€‚é…ä»»ä½•ä¸šåŠ¡åœºæ™¯ï¼Œè®©æ•°æ®çœŸæ­£ä¸ºä½ æœåŠ¡
          </div>
        </div>
      </div>
    </div>
    <div class="right-panel">
      <div class="login-methods">
        <div class="tab-buttons">
          <button class="tab-button active" onclick="switchTab('password')">è´¦å·å¯†ç ç™»å½•</button>
          <button class="tab-button" onclick="switchTab('wechat')">å¾®ä¿¡æ‰«ç ç™»å½•</button>
        </div>
        
        <div class="login-section active" id="password-login-section">
          <div class="form-group">
            <label class="form-label" for="username">ç”¨æˆ·å</label>
            <input type="text" id="username" class="form-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
          </div>
          <div class="form-group">
            <label class="form-label" for="password">å¯†ç </label>
            <input type="password" id="password" class="form-input" placeholder="è¯·è¾“å…¥å¯†ç ">
          </div>
          <div class="form-options">
            <label class="checkbox-label">
              <input type="checkbox" id="rememberPassword">
              <span class="checkmark"></span>
              è®°ä½å¯†ç 
            </label>
          </div>
          <div class="form-actions">
            <button class="login-button" onclick="handlePasswordLogin()">ç™»å½•</button>
          </div>
          
          <div style="margin-top: 16px; text-align: center;">
            <button onclick="openRegisterModal()" style="background: none; border: none; color: #667eea; font-size: 14px; font-weight: 600; cursor: pointer; padding: 8px 16px; border-radius: 8px; transition: all 0.3s ease;">
              æ³¨å†Œæ–°è´¦å·
            </button>
          </div>
          
          <!-- æ³¨å†Œå¼¹çª— -->
          <div id="register-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: #fff; border-radius: 16px; padding: 32px; width: 90%; max-width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h3 style="font-size: 18px; font-weight: 600; color: #333;">ç”¨æˆ·æ³¨å†Œ</h3>
                <button onclick="closeRegisterModal()" style="background: none; border: none; font-size: 20px; color: #999; cursor: pointer; padding: 4px;">&times;</button>
              </div>
              <div class="form-group">
                <label class="form-label" for="register-username">è´¦å·</label>
                <input type="text" id="register-username" class="form-input" placeholder="è¯·è®¾ç½®è´¦å·">
              </div>
              <div class="form-group">
                <label class="form-label" for="register-nickname">æ˜µç§°</label>
                <input type="text" id="register-nickname" class="form-input" placeholder="è¯·è®¾ç½®æ˜µç§°">
              </div>
              <div class="form-group">
                <label class="form-label" for="register-password">å¯†ç </label>
                <input type="password" id="register-password" class="form-input" placeholder="è¯·è®¾ç½®å¯†ç ">
              </div>
              <div class="form-group">
                <label class="form-label" for="register-password-confirm">ç¡®è®¤å¯†ç </label>
                <input type="password" id="register-password-confirm" class="form-input" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
              </div>
              <div class="form-actions" style="margin-top: 24px;">
                <button class="login-button" onclick="handleRegister()">æ³¨å†Œ</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="login-section" id="wechat-login-section">
          <div class="qr-box">
            <div class="qr-status" id="qrStatus">æ­£åœ¨è·å–äºŒç»´ç â€¦</div>
            <img id="qrImage" class="qr-image" style="display: none;" alt="å¾®ä¿¡äºŒç»´ç ">
            <a id="qrLink" href="#" target="_blank" rel="noreferrer" style="display: none; color: #667eea; text-decoration: none; font-size: 13px;">æ‰“å¼€å¾®ä¿¡æ‰«ç é“¾æ¥</a>
          </div>
          <div class="qr-actions">
            <button class="btn btn-secondary" id="btnRefreshQr">åˆ·æ–°äºŒç»´ç </button>
          </div>
        </div>
      </div>
      <div class="footer">
        <p class="footer-text">ç™»å½•å³è¡¨ç¤ºæ‚¨åŒæ„<a href="#" style="color: #667eea; text-decoration: none;">ã€Šç”¨æˆ·åè®®ã€‹</a>å’Œ<a href="#" style="color: #667eea; text-decoration: none;">ã€Šéšç§æ”¿ç­–ã€‹</a></p>
      </div>
    </div>
  </div>

  <script>
    async function fetchJson(url, opts) {
      const res = await fetch(url, opts);
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || ('HTTP ' + res.status));
      return data;
    }

    async function checkStatus() {
      const s = await fetchJson('/api/auth/status');
      if (s.loggedIn) window.location.href = '/my';
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      // ä» localStorage ä¸­è¯»å–è®°ä½çš„ç”¨æˆ·åå’Œå¯†ç 
      const savedUsername = localStorage.getItem('rememberedUsername');
      const savedPassword = localStorage.getItem('rememberedPassword');
      
      if (savedUsername && savedPassword) {
        document.getElementById('username').value = savedUsername;
        document.getElementById('password').value = savedPassword;
        document.getElementById('rememberPassword').checked = true;
      }
      
      // æ·»åŠ å›è½¦ç™»å½•åŠŸèƒ½
      document.getElementById('username').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          handlePasswordLogin();
        }
      });
      
      document.getElementById('password').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          handlePasswordLogin();
        }
      });
    });

    // è½®è¯¢æ£€æŸ¥ç™»å½•çŠ¶æ€
    let statusCheckInterval;
    
    function startStatusCheck() {
      // æ¸…é™¤ä¹‹å‰çš„è½®è¯¢
      if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
      }
      // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡ç™»å½•çŠ¶æ€
      statusCheckInterval = setInterval(async () => {
        try {
          const s = await fetchJson('/api/auth/status');
          if (s.loggedIn) {
            clearInterval(statusCheckInterval);
            window.location.href = '/my';
          }
        } catch (err) {
          console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', err);
        }
      }, 2000);
    }
    
    async function refreshQr() {
      const qrStatus = document.getElementById('qrStatus');
      const qrImage = document.getElementById('qrImage');
      const qrLink = document.getElementById('qrLink');
      
      qrStatus.textContent = 'æ­£åœ¨è·å–äºŒç»´ç â€¦';
      qrImage.style.display = 'none';
      qrLink.style.display = 'none';
      
      try {
        const qr = await fetchJson('/api/auth/wechat-qr');
        if (qr.url) {
          qrStatus.textContent = 'è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ç ç™»å½•';
          qrLink.href = qr.url;
          qrLink.textContent = 'æ‰“å¼€å¾®ä¿¡æ‰«ç é“¾æ¥';
          qrLink.style.display = 'block';
          // å¼€å§‹è½®è¯¢æ£€æŸ¥ç™»å½•çŠ¶æ€
          startStatusCheck();
        } else {
          qrStatus.textContent = 'å¾®ä¿¡ç™»å½•æœªé…ç½®ï¼Œè¯·ä½¿ç”¨å¼€å‘æ¨¡å¼ç™»å½•';
        }
      } catch (err) {
        qrStatus.textContent = 'è·å–äºŒç»´ç å¤±è´¥ï¼š' + err.message;
      }
    }

    function switchTab(tabName) {
      // åˆ‡æ¢æ ‡ç­¾æŒ‰é’®çŠ¶æ€
      const tabButtons = document.querySelectorAll('.tab-button');
      tabButtons.forEach(button => button.classList.remove('active'));
      event.target.classList.add('active');
      
      // åˆ‡æ¢ç™»å½•åŒºåŸŸ
      const loginSections = document.querySelectorAll('.login-section');
      loginSections.forEach(section => section.classList.remove('active'));
      document.getElementById(`${tabName}-login-section`).classList.add('active');
    }

    async function handlePasswordLogin() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const rememberPassword = document.getElementById('rememberPassword').checked;
      
      if (!username || !password) {
        Sweetalert2.fire({
          title: 'ç™»å½•å¤±è´¥',
          text: 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º',
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
        return;
      }
      
      try {
        await fetchJson('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, rememberPassword })
        });
        
        // å¦‚æœå‹¾é€‰äº†è®°ä½å¯†ç ï¼Œä¿å­˜åˆ° localStorage
        if (rememberPassword) {
          localStorage.setItem('rememberedUsername', username);
          localStorage.setItem('rememberedPassword', password);
        } else {
          // æ¸…é™¤ä¹‹å‰ä¿å­˜çš„å¯†ç 
          localStorage.removeItem('rememberedUsername');
          localStorage.removeItem('rememberedPassword');
        }
        
        window.location.href = '/my';
      } catch (err) {
        Sweetalert2.fire({
          title: 'ç™»å½•å¤±è´¥',
          text: err.message,
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
      }
    }
    
    function openRegisterModal() {
      const modal = document.getElementById('register-modal');
      modal.style.display = 'flex';
      // æ¸…ç©ºè¡¨å•
      document.getElementById('register-username').value = '';
      document.getElementById('register-nickname').value = '';
      document.getElementById('register-password').value = '';
    }
    
    function closeRegisterModal() {
      document.getElementById('register-modal').style.display = 'none';
    }
    
    async function handleRegister() {
      const username = document.getElementById('register-username').value.trim();
      const nickname = document.getElementById('register-nickname').value.trim();
      const password = document.getElementById('register-password').value.trim();
      const passwordConfirm = document.getElementById('register-password-confirm').value.trim();
      
      if (!username || !nickname || !password || !passwordConfirm) {
        Sweetalert2.fire({
          title: 'æ³¨å†Œå¤±è´¥',
          text: 'è´¦å·ã€æ˜µç§°å’Œå¯†ç ä¸èƒ½ä¸ºç©º',
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
        return;
      }
      
      if (!/^[a-zA-Z]/.test(username)) {
        Sweetalert2.fire({
          title: 'æ³¨å†Œå¤±è´¥',
          text: 'è´¦å·å¿…é¡»ä»¥è‹±æ–‡å­—æ¯å¼€å¤´',
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
        return;
      }
      
      if (username.length < 3 || username.length > 20) {
        Sweetalert2.fire({
          title: 'æ³¨å†Œå¤±è´¥',
          text: 'è´¦å·é•¿åº¦åº”åœ¨3-20ä¸ªå­—ç¬¦ä¹‹é—´',
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
        return;
      }
      
      if (nickname.length < 2 || nickname.length > 15) {
        Sweetalert2.fire({
          title: 'æ³¨å†Œå¤±è´¥',
          text: 'æ˜µç§°é•¿åº¦åº”åœ¨2-15ä¸ªå­—ç¬¦ä¹‹é—´',
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
        return;
      }
      
      if (password.length < 6) {
        Sweetalert2.fire({
          title: 'æ³¨å†Œå¤±è´¥',
          text: 'å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä¸ªå­—ç¬¦',
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
        return;
      }
      
      if (password !== passwordConfirm) {
        Sweetalert2.fire({
          title: 'æ³¨å†Œå¤±è´¥',
          text: 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´',
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
        return;
      }
      
      try {
        await fetchJson('/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, nickname, password })
        });
        
        Sweetalert2.fire({
          title: 'æ³¨å†ŒæˆåŠŸ',
          text: 'æ³¨å†ŒæˆåŠŸï¼Œè¯·ä½¿ç”¨æ–°è´¦å·ç™»å½•',
          icon: 'success',
          confirmButtonColor: '#667eea',
          width: '320px'
        }).then(() => {
          // æ¸…ç©ºæ³¨å†Œè¡¨å•å¹¶å…³é—­å¼¹çª—
          document.getElementById('register-username').value = '';
          document.getElementById('register-nickname').value = '';
          document.getElementById('register-password').value = '';
          document.getElementById('register-password-confirm').value = '';
          closeRegisterModal();
        });
      } catch (err) {
        Sweetalert2.fire({
          title: 'æ³¨å†Œå¤±è´¥',
          text: err.message,
          icon: 'error',
          confirmButtonColor: '#667eea',
          width: '320px'
        });
      }
    }

    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    checkStatus();
    
    // åˆå§‹åŒ–äºŒç»´ç 
    refreshQr();
    
    // ç»‘å®šäº‹ä»¶
    document.getElementById('btnRefreshQr').addEventListener('click', refreshQr);
  </script>
</body>
</html>